const init=()=>{document.querySelectorAll('[data-swap-gallery]').forEach(setup)};
const setup=root=>{
  const slides=[...root.querySelectorAll('.swap-slide')];
  const dots=[...(root.querySelector('[data-dots]')||{querySelectorAll:()=>[]}).querySelectorAll('.swap-dot')];
  if(!slides.length)return;
  let i=0,lock=false,hover=false;
  let notchCount=0,notchDir=0,pxAcc=0,pxDir=0;
  let touchStartX=0,touchStartY=0,activeAxis=null;
  const isMobile=()=>window.matchMedia('(max-width: 749px)').matches;
  const len=slides.length;
  const TRACKPAD_MIN=0.22,TRACKPAD_MIN_PX=140,NOTCH_TARGET=1;
  const preload=src=>new Promise(r=>{const img=new Image();img.decoding='async';img.src=src;const d=()=>r(img);if(img.decode)img.decode().then(d).catch(d);else img.onload=d,img.onerror=d});
  const ensure=async idx=>{const s=slides[idx];if(!s)return;if(s.dataset.ready==='1'||s.querySelector('img'))return;const src=s.dataset.src;if(!src){s.dataset.ready='1';return}const alt=s.dataset.alt||'';const img=await preload(src);img.alt=alt;img.className='swap-img';s.appendChild(img);s.dataset.ready='1';s.removeAttribute('data-src')};
  const applyAR=n=>{const ar=slides[n]?.dataset.ar||slides[0]?.dataset.ar||'1';root.style.setProperty('--media-preview-ratio',ar)};
  const animate=(from,to,dir)=>{const axisX=isMobile();const start=axisX?(dir>0?'translateX(100%)':'translateX(-100%)'):(dir>0?'translateY(100%)':'translateY(-100%)');const exit=axisX?(dir>0?'translateX(-100%)':'translateX(100%)'):(dir>0?'translateY(-100%)':'translateY(100%)');to.classList.add('is-active');to.style.transition='none';to.style.transform=start;to.offsetWidth;to.style.transition='transform 300ms ease';from.style.transition='transform 300ms ease';requestAnimationFrame(()=>{to.style.transform=axisX?'translateX(0)':'translateY(0)';from.style.transform=exit});const done=()=>{from.classList.remove('is-active');from.style.transition='';from.style.transform='';to.style.transition='';to.style.transform='';lock=false;to.removeEventListener('transitionend',done)};to.addEventListener('transitionend',done,{once:true})};
  const setIndex=async(n,dir)=>{if(n===i||n<0||n>len-1||lock)return;lock=true;applyAR(n);await ensure(n);const from=slides[i],to=slides[n];animate(from,to,dir);dots.forEach(d=>d.classList.toggle('is-active',Number(d.dataset.index)===n));i=n;ensure(i+1);ensure(i-1)};
  const next=()=>setIndex(Math.min(i+1,len-1),1);
  const prev=()=>setIndex(Math.max(i-1,0),-1);
  const normalize=e=>{let d=isMobile()?Math.abs(e.deltaX)>Math.abs(e.deltaY)?e.deltaX:0:e.deltaY;if(e.deltaMode===1)d*=16;else if(e.deltaMode===2)d*=root.clientHeight;return d};
  const wheel=e=>{if(!hover)return;e.preventDefault();if(lock)return;const d=normalize(e);if(!d)return;const s=Math.sign(d),a=Math.abs(d);const isNotch=a>=80;const trackpad=()=>{const th=Math.max(TRACKPAD_MIN_PX,root.clientHeight*TRACKPAD_MIN);if(pxDir===0||s===pxDir)pxAcc+=a;else{pxAcc=a;pxDir=s}if(pxAcc>=th){s>0?next():prev();pxAcc=0;pxDir=0}};const notch=()=>{if(notchDir===0||s===notchDir)notchCount+=s;else{notchCount=s;notchDir=s}if(Math.abs(notchCount)>=NOTCH_TARGET){s>0?next():prev();notchCount=0;notchDir=0}};isNotch?notch():trackpad()};
  const tStart=e=>{const t=e.touches[0];touchStartX=t.clientX;touchStartY=t.clientY;activeAxis=null};
  const tMove=e=>{if(lock)return;const t=e.touches[0];const dx=t.clientX-touchStartX,dy=t.clientY-touchStartY;if(activeAxis===null)activeAxis=Math.abs(dx)>Math.abs(dy)?'x':'y';const axis=isMobile()?'x':'y';if(activeAxis===axis)e.preventDefault();const delta=axis==='x'?dx:dy;const a=Math.abs(delta);const th=isMobile()?Math.max(90,root.clientWidth*0.25):Math.max(90,root.clientHeight*0.25);if(a>=th){const goNext=axis==='x'?delta<0:delta>0;goNext?next():prev()}};
  const key=e=>{if(!hover&&document.activeElement!==root)return;if(['ArrowUp','ArrowDown','PageUp','PageDown','Home','End',' '].includes(e.key))e.preventDefault();if(lock)return;const axis=isMobile()?'x':'y';if(axis==='y'){if(e.key==='ArrowDown'||e.key==='PageDown'||e.key===' ')next();if(e.key==='ArrowUp'||e.key==='PageUp')prev()}else{if(e.key==='ArrowRight')next();if(e.key==='ArrowLeft')prev()}};
  const dotClick=e=>{const n=Number(e.currentTarget.dataset.index);setIndex(n,n>i?1:-1)};
  root.addEventListener('mouseenter',()=>{hover=true},{passive:true});
  root.addEventListener('mouseleave',()=>{hover=false;pxAcc=0;pxDir=0;notchCount=0;notchDir=0},{passive:true});
  root.addEventListener('wheel',wheel,{passive:false});
  root.addEventListener('touchstart',tStart,{passive:true});
  root.addEventListener('touchmove',tMove,{passive:false});
  root.addEventListener('keydown',key);
  dots.forEach(d=>d.addEventListener('click',dotClick));
  root.tabIndex=0;
  applyAR(0);
  ensure(0);ensure(1);
};
document.addEventListener('DOMContentLoaded',init);
